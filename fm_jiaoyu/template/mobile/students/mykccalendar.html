<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html" charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="no">
<meta name="format-detection" content="telephone=no">
<title>{$school['title']}</title>
<link rel="stylesheet" type="text/css" href="{OSSURL}public/mobile/css/new_yab1.css?v=1?v=1111" />
<link rel="stylesheet" type="text/css" href="{OSSURL}public/mobile/css/common.css" />
{php echo register_jssdks();}
<script type="text/javascript" src="{MODULE_URL}public/mobile/js/jquery-1.11.3.min.js?v=4.8"></script>
{php include $this->template('students/candercss');} 
<style>
.schoolCard{font-size: 15px;color: rgb(16, 16, 16);}
.click {width: auto;height: 40px;right: 0;top: 93px;background-color: #ceb750;border-radius: 50px 0 0 50px;z-index: 2; position: fixed;}
.font_icon{width: 15px;margin-top: 12px;margin-left: 7px;margin-right: 2px;}
.useredits{line-height: 15px;float: right;margin-right: 4px;color:#fff;width:44px;margin-top: 5px}
.famiyls {width: 100%;text-align: left;color: #666;display: inline-flex;border-bottom:1px solid #e9e9e9;margin-top: 20px;}
.left{width: 50%;float: left;display: flex;}
.left_img>img{height: 36px; margin-top: -16px;border-radius: 50%;}
.left_pard{text-align: center;}
.left_name{line-height: 36px;padding: 5px;}
.right{width: 50%;float: right;}
.right>span{line-height: 43px; margin-left: 10px;float: left;}
.weui_switch {font-size: 14px;-webkit-appearance: none;-moz-appearance: none;appearance: none;position: relative;width: 48px;height: 28px;border: 1px solid #DFDFDF;outline: 0;border-radius: 16px;box-sizing: border-box;background: #DFDFDF;vertical-align: middle;float: right;top: 8px;right: 12px;}
.weui_switch:before {content: " ";position: absolute;top: 0;left: 0;width: 46px;height: 26px;border-radius: 15px;background-color: #FDFDFD;-webkit-transition: -webkit-transform .3s;transition: transform .3s;}
.weui_switch:after {content: " ";position: absolute;top: 0;left: 0;width: 26px;height: 26px;border-radius: 15px;background-color: #FFFFFF;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);-webkit-transition: -webkit-transform .3s;transition: transform .3s;}
.manual_student_list_search {padding: 10px;box-sizing: border-box;width: 98%;margin-top: 62px;margin-bottom: 8px;left: 5px;height: 42px;border: 1px solid #d4d4d4;position: relative;background-color: #fff;border-radius: 6px;}
.manual_student_list_search .search_text {border: none;height: 22px;line-height: 22px;font-size: 14px;box-sizing: border-box;width: 100%;padding-right: 30px;}
.manual_student_list_search .search_btn {width: 22px;height: 22px;background: url({OSSURL}public/mobile/img/B_gou.png) no-repeat center;background-size: 22px;position: absolute;right: 10px;
top: 10px;}
.btnQDBox {top: 81%;width: 28px;height: 28px;background-color: #ef841a;border-radius: 50%;font-size: 16px;color: #fff;text-align: center;position: absolute;right: 73px;font-weight: bold;line-height: 28px;transform: translateY(-50%);-webkit-transform: translateY(-50%);-moz-box-shadow: 2px 2px 5px #333333;-webkit-box-shadow: 2px 2px 5px #333333;box-shadow: 2px 2px 5px #716e6e;}
.btnXGBox {top: 81%;width: 40px;height: 28px;background-color: #0db15c;border-radius: 13%;font-size: 16px;color: #fff;text-align: center;position: absolute;right: 12px;font-weight: bold;line-height: 28px;transform: translateY(-50%);-webkit-transform: translateY(-50%);-moz-box-shadow: 2px 2px 5px #333333;-webkit-box-shadow: 2px 2px 5px #333333;box-shadow: 2px 2px 5px #716e6e;}
.qdbtn{top: 50%;color: #fff;border-radius: 3px;right: 2px;text-align: center;width: 32%;margin-left: 87px;background-color: #19d2bf;height: 25px;position: relative;padding-top: 10p;line-height: 25px;transform: translateY(-50%);-webkit-transform: translateY(-50%);-moz-box-shadow: 2px 2px 5px #333333;-webkit-box-shadow: 2px 2px 5px #333333;box-shadow: 1px 1px 1px #716e6e;}
.qdbtnre{ margin-top: 8px; margin-left: 95px;}
.qdbtnre>img{width: 30px;}
</style>
</head>
<body>
<header class="mainColor">
    <div class="headerContent">  
        <a href="javascript:;" class="select_last_left" onclick="CalendarHandler.CalculateLastMonthDays();">
            <div class="next_right"><</div>
        </a>
        <div class="select_date">
            <a class="selectBtn selectYear"></a>
            <a class="selectBtn selectMonth"></a>
        </div>
        <a href="javascript:;" class="select_next_right" onclick="CalendarHandler.CalculateNextMonthDays();">
            <div class="next_right">></div>
        </a>
    </div>
</header>
<section>
    <div class="conentBox">
        <div class="topInfo">
            <div class="monthTitle">本月出勤</div>
            <div class="monthData">共<span></span>天</div>
        </div>
        <div class="top_bottom">{$student['s_name']}</div>
    </div>
</section>
<div class="datePickerBox">
    <div id="CalendarMain">
        <div id="context">
            <div class="week">
                <div>日</div>
                <div>一</div>
                <div>二</div>
                <div>三</div>
                <div>四</div>
                <div>五</div>
                <div>六</div>
            </div>
            <div id="center">
                <div id="centerMain">
                    <div id="selectYearDiv"></div>
                    <div id="centerCalendarMain">
                        <div id="Container"></div>
                    </div>
                    <div id="selectMonthDiv"></div>
                </div>
            </div>

        </div>
    </div>

</div>
<!--左边弹窗-->
<!--微信打卡弹窗-->
<div class="wxAlert" style="display: none">
    <div class="popupWxAlertxBox"></div>
    <div class="wxAlertContent">
    </div>
</div>
<!--正常打卡弹窗-->
<div class="commonAlert" style="display: none">
    <div class="popupWxAlertxBox"></div>
    <div class="wxAlertContent" onclick="wxImageShow(this);">
    </div>
</div>


<div class="popUpBox" style="display: none">
	<div class="trackMatte"></div>
	<div class="popContentBox">
		<input type="hidden" id="kcid" value="" />
		<div class="poptitle" id="sname">今日课程签到情况</div>
		<div class="sectionContBox">
			<div id="family">
			</div>
			<div class="btnBox">
				<div class="btnPass" id="lkqd" onclick="lkqd();" style="display:none;">立刻签到</div>
				<div class="btnCancel">关闭</div>
			</div>
		</div>
	</div>
</div>

<input id="flag" value="1" type="hidden">
<input id="nowtime" value="{php echo date('Y-m-d',TIMESTAMP)}" type="hidden">
{php include $this->template('port');} 
<script type="text/javascript">



var flag = $("#flag").val();
if (flag == 1){
	var nowtime = $("#nowtime").val();
	GetAttendData(nowtime);
}else{
	$("#flag").val("");
}
//设置标注
function setTip(vacation, absent, signIn, rest) {
var date = [];
//清空

if ($(".dayItem").length >= 2) {
	$('.dayItem:last-child .item').each(function (index, obj) {

		date.push($(this));
	});

} else {
	$('.item').each(function (index, obj) {
		date.push($(this));
	});
}

if (checkSet()) {
	$(date).each(function (index, obj) {

		if (signIn.indexOf(parseInt($(this).find('.dateBox').text())) != -1) {
			$(this).find('.tipBox').text('签');
			$(this).find('.tipBox').addClass('signin');
			$(this).find('.tipBox').css('display', 'none');
			$(this).find('.dateBox').addClass('absentTip');
		}
		if (absent.indexOf(parseInt($(this).find('.dateBox').text())) != -1) {
			$(this).find('.tipBox').text('缺');
			$(this).find('.tipBox').css('display', 'none');

			$(this).find('.dateBox').addClass('absentTip');
		}


	});
}

//公休日
$(date).each(function (index, obj) {

	if (vacation.indexOf(parseInt($(this).find('.dateBox').text())) != -1) {
		$(this).find('.tipBox').text('假');
		$(this).find('.tipBox').css('display', 'none');
		$(this).find('.dateBox').addClass('leaveTip');
	}

	if (rest.indexOf(parseInt($(this).find('.dateBox').text())) != -1) {
		$(this).find('.tipBox').text('休');
		$(this).find('.dateBox').removeClass('absentTip');
		$(this).find('.tipBox').addClass('signin');
		$(this).find('.tipBox').css('display', 'block');
	}



});
setCurrentDay(date);
}



//设置当前日期
function setCurrentDay(dateItem) {
var date = new Date();
var year = $(".selectYear").text().substring(0, 4);
var month = $(".selectMonth").text().substring(0, 2);
var tempMonth = parseInt(month);
var tempYear = parseInt(year);
var date = new Date();
var currentYear = date.getFullYear();
var currentMonth = date.getMonth() + 1;
var day = date.getDate();
if (tempYear == currentYear && tempMonth == currentMonth) {
	var dayItem = $('.item .dateBox').text();
	$(dateItem).each(function (index, obj) {
		if ($(this).find('.dateBox').text() == day) {
			$(this).find('.outSide').css('display', 'block');
		}
	});
}
}

///////////////////////////    初始化 考勤数据 //////////////////////////////////
function initAttendData(array) {
var vacation = []; //请假
var absent = []; //缺
var signIn = []; //微信签
var rest = []; //休
if (array != null && array.length > 0) {
	for (var i = 0; i < array.length; i++) {
		var type = array[i]["Type"];
		var date = array[i]["Date"];
		//微信签到
		if (type == "wx" || type == "card") {
			signIn.push(date);
		}
			//缺课
		else if (type == "skip") {
			absent.push(date);
		}
			//请假
		else if (type == "leave") {
			vacation.push(date);
		}
		if (type == "holiday") {
			rest.push(date);
		}
	}
}
setTip(vacation, absent, signIn, rest);
}

//获取状态数据
function GetAttendData(time) {
	$.ajax({
		url: "{php echo $this->createMobileUrl('dongtaiajax', array('op' => 'GetAttendData','schoolid' => $schoolid), true)}",
		type: "post",
		data: {
			sDate: time,
			sid: "{$it['sid']}",
			schoolid: "{$schoolid}"
		},
		success: function (data) {
			var dt = eval("(" + data + ")");
			var count = dt.AttendanceCount;
			$(".monthData").find("span").text(count);
			var lstAttendInfo = dt.lstAttendInfo;
			initAttendData(lstAttendInfo);
			GetHolidayData(time);
		}
	});
}

//获取公休日
function GetHolidayData(time) {
$.ajax({
	url: "{php echo $this->createMobileUrl('dongtaiajax', array('op' => 'GetHolidayData','schoolid' => $schoolid,'bj_id'=>$student['bj_id']), true)}",
	type: "post",
	dataType: "html",
	data: {
		sDate: time
	},
	success: function (data) {
		var dt = eval("(" + data + ")");
		//var lstAttendInfo = dt.lstAttendInfo;
		setHolidayDataTip(dt);

	}
});
}

//获取补班
function GetOverTime(time) {
$.ajax({
	url: "/1046/AttendCalendar/GetOverTime",
	type: "post",
	dataType: "html",
	data: {
		sDate: time
	},
	success: function (data) {
		var dt = eval("(" + data + ")");

		setOverTimeTip(dt);

	}
});
}

//设置补班
function setOverTimeTip(holidayData) {
var date = [];
if ($(".dayItem").length >= 2) {
	$('.dayItem:last-child .item').each(function (index, obj) {
		date.push($(this));
	});
} else {
	$('.item').each(function (index, obj) {
		date.push($(this));
	});
}

$(date).each(function (index, obj) {
	if (holidayData.indexOf(parseInt($(this).find('.dateBox').text())) != -1) {
		$(this).find('.tipBox').text('签');
		$(this).find('.tipBox').addClass('signin');
	}
});
}


//设置公休日
function setHolidayDataTip(holidayData) {
var date = [];
if ($(".dayItem").length >= 2) {
	$('.dayItem:last-child .item').each(function (index, obj) {
		date.push($(this));
	});
} else {
	$('.item').each(function (index, obj) {
		date.push($(this));
	});
}

$(date).each(function (index, obj) {
	if (holidayData.indexOf(parseInt($(this).find('.dateBox').text())) != -1) {
		$(this).find('.tipBox').text('休');
		$(this).find('.tipBox').addClass('signin');
		$(this).find('.dateBox').removeClass('absentTip');
		$(this).find('.tipBox').css('display', 'block');
	}
});
}


//检查是否允许设置标注
function checkSet(e) {
var year = $(".selectYear").text().substring(0, 4);
var month = $(".selectMonth").text().substring(0, 2);
var tempMonth = parseInt(month);
var tempYear = parseInt(year);
var date = new Date();
var currentYear = date.getFullYear();
var currentMonth = date.getMonth() + 1;
var day = date.getDate();

if (tempYear > currentYear) {
	return false;
}
if (tempYear == currentYear && tempMonth > currentMonth) {
	return false;
}

return true;
};

//检查日期是否允许点击，并且弹出框
function checkClick(e, obj) {
var year = $(".selectYear").text().substring(0, 4);
var month = $(".selectMonth").text().substring(0, 2);
var tempMonth = parseInt(month);
var tempYear = parseInt(year);
var date = new Date();
var currentYear = date.getFullYear();
var currentMonth = date.getMonth() + 1;
var day = date.getDate();

if (tempYear > currentYear) {
	e.preventDefault();
	return false;

} else {
	if (tempYear == currentYear && tempMonth > currentMonth) {

		e.preventDefault();
		return false;
	}
	if (tempYear == currentYear && tempMonth == currentMonth) {
		var tempDay = parseInt($(obj).find('.dateBox').text());
		if (tempDay > day) {
			e.preventDefault();
			return false;
		}
	}
}

return true;
};

//设置选中边框
function setClickDate(obj) {
if ($(obj).find('.dateBox').text() != '999') {
	$('.outSide').css('display', '');
	$('.outSide').removeClass('currentItemOutSide');
	$(obj).find('.outSide').css('display', 'inline-block');
}

}

$(function () {
var array = []

CalendarHandler.initialize();

// popInitialize(); //蒙版初始化
initAttendData(array);
//setTip();//设置提示
$(".choice_baby").on("click", function (e) {
	e.stopPropagation();
	$(".slide_left_menu_bg").addClass("show_menu_bg");
});
$(".slide_left_menu_bg").on("click", function () {
	$(this).removeClass("show_menu_bg");
});


//屏蔽滚动
function setbodyNoscroll() {
	$('html').css({
		"height": "100%",
		"overflow": "hidden"
	});
	$('body').css({
		"height": "100%",
		"overflow": "hidden"
	});
}

//蒙版隐藏
$('.wxAlert,.vacationAlert,.commonAlert').on("click", function () {
	$('html').css({
		"height": "auto",
		"overflow": "visible"
	});
	$('body').css({
		"height": "auto",
		"overflow": "visible"
	});
	$(this).hide();
})
});

var CalendarHandler = {
currentYear: 0,
currentMonth: 0,
isRunning: false,
showYearStart: 2009,
tag: 0,
initialize: function () {
	$calendarItem = this.CreateCalendar(0, 0, 0);
	$("#Container").append($calendarItem);


	$("#selectYearDiv").css("width", $("#context").width() + "px");
	$("#selectMonthDiv").css("width", $("#context").width() + "px");
	$("#centerCalendarMain").css("width", $("#context").width() + "px");


	$("#Container").css("height", "0px").css("width", "0px").css("margin-left", $("#context").width() / 2 + "px").css("margin-top", ($("#context").height() - 30) / 2 + "px");
	$("#Container").animate({
		width: $("#context").width() + "px",
		height: ($("#context").height() - 30) * 2 + "px",
		marginLeft: "0px",
		marginTop: "0px"
	}, 300, function () {
		$calendarItem.css("visibility", "visible");
	});
	$(".dayItem").css("width", $("#context").width() + "px");
	var itemPaddintTop = $(".dayItem").height() / 6;
	$(".item").css({
		"width": $(".week").width() / 7 + "px",
		"line-height": itemPaddintTop + "px",
		"height": itemPaddintTop + "px"
	});
	$(".week>div").css("width", $(".week").width() / 7 + "px");
	this.CSS();
},
CreateSelectYear: function (showYearStart) {
	CalendarHandler.showYearStart = showYearStart;
	$(".currentDay").show();
	$("#selectYearDiv").children().remove();
	var yearindex = 0;
	for (var i = showYearStart; i < showYearStart + 12; i++) {
		yearindex++;
		if (i == showYearStart) {
			$last = $("<div>往前</div>");
			$("#selectYearDiv").append($last);
			$last.click(function () {
				CalendarHandler.CreateSelectYear(CalendarHandler.showYearStart - 10);
			});
			continue;
		}
		if (i == showYearStart + 11) {
			$next = $("<div>往后</div>");
			$("#selectYearDiv").append($next);
			$next.click(function () {
				CalendarHandler.CreateSelectYear(CalendarHandler.showYearStart + 10);
			});
			continue;
		}

		if (i == this.currentYear) {
			$yearItem = $("<div class=\"currentYearSd\" id=\"" + yearindex + "\">" + i + "</div>")

		} else {
			$yearItem = $("<div id=\"" + yearindex + "\">" + i + "</div>");
		}
		$("#selectYearDiv").append($yearItem);

		$yearItem.click(function () {
			$calendarItem = CalendarHandler.CreateCalendar(Number($(this).html()), 1, 1);
			$("#Container").append($calendarItem);
			CalendarHandler.CSS();
			CalendarHandler.isRunning = true;
			$($("#Container").find(".dayItem")[0]).animate({
				height: "0px"
			}, 300, function () {
				$(this).remove();
				CalendarHandler.isRunning = false;
			});
			$("#centerMain").animate({
				marginLeft: -$("#center").width() + "px"
			}, 500);
		});
		if (yearindex == 1 || yearindex == 5 || yearindex == 9) $("#selectYearDiv").find("#" + yearindex).css("border-left-color", "#fff");
		if (yearindex == 4 || yearindex == 8 || yearindex == 12) $("#selectYearDiv").find("#" + yearindex).css("border-right-color", "#fff");

	}
	$("#selectYearDiv>div").css("width", ($("#center").width() - 4) / 4 + "px").css("line-height", ($("#center").height() - 4) / 3 + "px");
	$("#centerMain").animate({
		marginLeft: "0px"
	}, 300);
},
CreateSelectMonth: function () {
	$(".currentDay").show();
	$("#selectMonthDiv").children().remove();
	for (var i = 1; i < 13; i++) {
		if (i == this.currentMonth) $monthItem = $("<div class=\"currentMontSd\" id=\"" + i + "\">" + i + "月</div>");
		else $monthItem = $("<div id=\"" + i + "\">" + i + "月</div>");
		$("#selectMonthDiv").append($monthItem);
		$monthItem.click(function () {
			$calendarItem = CalendarHandler.CreateCalendar(CalendarHandler.currentYear, Number($(this).attr("id")), 1);
			$("#Container").append($calendarItem);
			CalendarHandler.CSS()
			CalendarHandler.isRunning = true;
			$($("#Container").find(".dayItem")[0]).animate({
				height: "0px"
			}, 300, function () {
				$(this).remove();
				CalendarHandler.isRunning = false;
			});
			$("#centerMain").animate({
				marginLeft: -$("#center").width() + "px"
			}, 500);
		});
		if (i == 1 || i == 5 || i == 9) $("#selectMonthDiv").find("#" + i).css("border-left-color", "#fff");
		if (i == 4 || i == 8 || i == 12) $("#selectMonthDiv").find("#" + i).css("border-right-color", "#fff");
	}
	$("#selectMonthDiv>div").css("width", ($("#center").width() - 4) / 4 + "px").css("line-height", ($("#center").height() - 4) / 3 + "px");
	$("#centerMain").animate({
		marginLeft: -$("#center").width() * 2 + "px"
	}, 300);
},
IsRuiYear: function (aDate) {
	return (0 == aDate % 4 && (aDate % 100 != 0 || aDate % 400 == 0));
},
CalculateWeek: function (y, m, d) {
	var arr = "7123456".split("");
	with (document.all) {
		var vYear = parseInt(y, 10);
		var vMonth = parseInt(m, 10);
		var vDay = parseInt(d, 10);
	}
	var week = arr[new Date(y, m - 1, vDay).getDay()];
	return week;
},
CalculateMonthDays: function (m, y) {
	var mDay = 0;
	if (m == 0 || m == 1 || m == 3 || m == 5 || m == 7 || m == 8 || m == 10 || m == 12) {
		mDay = 31;
	} else {
		if (m == 2) {
			//判断是否为润年
			var isRn = this.IsRuiYear(y);
			if (isRn == true) {
				mDay = 29;
			} else {
				mDay = 28;
			}
		} else {
			mDay = 30;
		}
	}
	return mDay;
},
CreateCalendar: function (y, m, d) {
	$dayItem = $("<div class=\"dayItem\"></div>");
	$borderLine = $("<div class=\"borderLine\"></div>");
	//获取当前月份的天数
	var nowDate = new Date();
	if (y == nowDate.getFullYear() && m == nowDate.getMonth() + 1 || (y == 0 && m == 0))
		$(".currentDay").hide();
	var nowYear = y == 0 ? nowDate.getFullYear() : y;
	this.currentYear = nowYear;
	var nowMonth = m == 0 ? nowDate.getMonth() + 1 : m;
	this.currentMonth = nowMonth;
	var nowDay = d == 0 ? nowDate.getDate() : d;
	$(".selectYear").html(nowYear + "年");
	nowMonth = nowMonth > 9 ? nowMonth : '0' + nowMonth;
	$(".selectMonth").html(nowMonth + "月");
	//获取年-月-天数
	var nowDaysNub = this.CalculateMonthDays(nowMonth, nowYear);
	//获取当月第一天是星期几

	var nowWeek = parseInt(this.CalculateWeek(nowYear, nowMonth, 1));
	//console.log(nowWeek);

	//获取上个月的天数
	var t = -1;
	//根据某月第一天是周几 生成几个空格
	switch (nowWeek) {
		case 1:
			for (var i = 0; i < 1; i++) {
				t++;
				$dayItem.append("<a class=\"item lastItem\"><div class='dateBox weekBox'>" + 999 + "</div><div class='outSide'></div></a>");
			}
			break;
		case 2:
			for (var i = 0; i < 2; i++) {
				t++;
				$dayItem.append("<a class=\"item lastItem\"><div class='dateBox weekBox'>" + 999 + "</div><div class='outSide'></div></a>");
			}
			break;
		case 3:
			for (var i = 0; i < 3; i++) {
				t++;
				$dayItem.append("<a class=\"item lastItem\"><div class='dateBox weekBox'>" + 999 + "</div><div class='outSide'></div></a>");
			}
			break;
		case 4:
			for (var i = 0; i < 4; i++) {
				t++;
				$dayItem.append("<a class=\"item lastItem\"><div class='dateBox weekBox'>" + 999 + "</div><div class='outSide'></div></a>");
			}
			break;
		case 5:
			for (var i = 0; i < 5; i++) {
				t++;
				$dayItem.append("<a class=\"item lastItem\"><div class='dateBox weekBox'>" + 999 + "</div><div class='outSide'></div></a>");
			}
			break;
		case 6:
			for (var i = 0; i < 6; i++) {
				t++;
				$dayItem.append("<a class=\"item lastItem\"><div class='dateBox weekBox'>" + 999 + "</div><div class='outSide'></div></a>");
			}
			break;
		case 7:
			//no thing
			break;
	}
	//生成当月的日期
	for (var i = 0; i < nowDaysNub; i++) {
		t++;
		if (t % 7 == 0) {
			$dayItem.append("<div class=\"borderLine\"></div>");
		}
		if (i == (nowDay - 1)) {
			var week = parseInt(this.CalculateWeek(nowYear, nowMonth, i + 1));
			if (week == 6 || week == 7) {
				$dayItem.append(`<a class=\"item\" onclick='showkcsign(${i + 1})'><div class='dateBox weekBox'>${i + 1}</div><div class='outSide'></div><div class='tipBox'></div></a>`);
			} else {
				$dayItem.append(`<a class=\"item\" onclick='showkcsign(${i + 1})'><div class='dateBox'>${i + 1}</div><div class='outSide'></div><div class='tipBox'></div></a>`);
			}

		} else {
			var week = parseInt(this.CalculateWeek(nowYear, nowMonth, i + 1));
			if (week == 6 || week == 7) {
				$dayItem.append(`<a class=\"item\" onclick='showkcsign(${i + 1})'><div class='dateBox weekBox'>${i + 1}</div><div class='outSide'></div><div class='tipBox'></div></a>`);
			} else {
				$dayItem.append(`<a class=\"item\" onclick='showkcsign(${i + 1})'><div class='dateBox'>${i + 1}</div><div class='outSide'></div><div class='tipBox'></div></a>`);
			}

		}

	}
	$dayItem.append("<div class=\"borderLine\"></div>");
	return $dayItem;
},
CSS: function () {
	$(".dayItem").css("width", $("#context").width() + "px");
	var itemPaddintTop = ($(".dayItem").height() - 5) / 6;
	$(".item").css({
		"width": $(".week").width() / 7 + "px",
		"line-height": 50 + "px",
		"height": 50 + "px"
	});
},
CalculateNextMonthDays: function () {
	if (this.isRunning == false) {
		$(".currentDay").show();
		var m = this.currentMonth == 12 ? 1 : this.currentMonth + 1;
		var y = this.currentMonth == 12 ? (this.currentYear + 1) : this.currentYear;
		var d = 0;
		var nowDate = new Date();
		if (y == nowDate.getFullYear() && m == nowDate.getMonth() + 1) d = nowDate.getDate();
		else d = 1;
		$calendarItem = this.CreateCalendar(y, m, d);
		$("#Container").append($calendarItem);
		var year = $(".selectYear").text().substring(0, 4);
		var month = $(".selectMonth").text().substring(0, 2);
		var time = year + "-" + month + "-01";

		//补班
		//GetOverTime(time);
		GetAttendData(time);
		//GetHolidayData(time);
		this.CSS();
		this.isRunning = true;
		$($("#Container").find(".dayItem")[0]).animate({
			height: "0px"
		}, 300, function () {


			$(this).remove();
			CalendarHandler.isRunning = false;
		});
	}
},
CalculateLastMonthDays: function () {
	if (this.isRunning == false) {
		$(".currentDay").show();
		var nowDate = new Date();
		var m = this.currentMonth == 1 ? 12 : this.currentMonth - 1;
		var y = this.currentMonth == 1 ? (this.currentYear - 1) : this.currentYear;
		var d = 0;

		if (y == nowDate.getFullYear() && m == nowDate.getMonth() + 1) d = nowDate.getDate();
		else d = 1;
		$calendarItem = this.CreateCalendar(y, m, d);
		$("#Container").append($calendarItem);

		var year = $(".selectYear").text().substring(0, 4);
		var month = $(".selectMonth").text().substring(0, 2);
		var time = year + "-" + month + "-01";

		GetAttendData(time);
		//补班
		//GetOverTime(time);
		//setTip();
		var itemPaddintTop = $(".dayItem").height() / 6;
		this.CSS();
		this.isRunning = true;


		$($("#Container").find(".dayItem")[0]).animate({
			height: "0px"
		}, 300, function () {
			$(this).remove();
			CalendarHandler.isRunning = false;
		});
	}
},
CreateCurrentCalendar: function () {
	if (this.isRunning == false) {
		$(".currentDay").hide();
		$calendarItem = this.CreateCalendar(0, 0, 0);
		$("#Container").append($calendarItem);
		this.isRunning = true;
		$($("#Container").find(".dayItem")[0]).animate({
			height: "0px"
		}, 300, function () {
			$(this).remove();
			CalendarHandler.isRunning = false;
		});
		this.CSS();
		$("#centerMain").animate({
			marginLeft: -$("#center").width() + "px"
		}, 500);
	}
},

}
</script>
<script>
var ALI_URL = "{$urls}";
var ALI_URL_VIEDO = "{$urls}";
var WeixinApi = (function () {
	return {
        imagePreview    :imagePreview
    }; 
	
    "use strict";

    /**
     * 调起微信Native的图片播放组件。
     * 这里必须对参数进行强检测，如果参数不合法，直接会导致微信客户端crash
     *
     * @param {String} curSrc 当前播放的图片地址
     * @param {Array} srcList 图片地址列表
     */
    function imagePreview(curSrc,srcList) {
        if(!curSrc || !srcList || srcList.length == 0) {
            return;
        }
        WeixinJSBridge.invoke('imagePreview', {
            'current' : curSrc,
            'urls' : srcList
        });
    }
	
    return {
        version         :"2.5",
        imagePreview    :imagePreview
    };
})();

function wxImageShow(node){
	var srcList = new Array();
	var watermark='';
	var imgs = $(node).closest('.wxAlertContent').find("img");
	var curSrc = $(node).find("img")[0]['src'].split("@");
	
	var curImgIndex=0;
	for(i=0;i<imgs.length;i++){
		var imgsrc = imgs[i]['src'].split("@");
		if(imgsrc.length>1){
			if(imgsrc[1].split("watermark").length>1){
				srcList.push(imgsrc[0].replace(ALI_URL,ALI_URL_VIEDO)+'@watermark'+imgsrc[1].split("watermark")[1]);
				watermark = '@watermark'+imgsrc[1].split("watermark")[1];
			}else{
				srcList.push(imgsrc[0].replace(ALI_URL,ALI_URL_VIEDO));
			}
		}else{
			srcList.push(imgsrc[0]);
		}
		if(curSrc[0]==imgsrc[0]){
			curImgIndex=i;
		}
	}
	curSrc[0]=curSrc[0]+watermark;

	WeixinApi.imagePreview(curSrc[0].replace(ALI_URL,ALI_URL_VIEDO), srcList);
}
</script>
<script>
WeixinJSHideAllNonBaseMenuItem();
/**微信隐藏工具条**/
function WeixinJSHideAllNonBaseMenuItem(){
	if (typeof wx != "undefined"){
		wx.ready(function () {
			
			wx.hideAllNonBaseMenuItem();
		});
	}
}
</script>
{php include $this->template('footer');} 
</body>
</html>

<script>
$('.btnCancel').click(function() {
	$('.popUpBox').hide();
	$('html,body').removeClass('popNoscroll');
});
function showkcsign(day){
	e = window.event;
	e.stopPropagation();
	e.preventDefault();
	$('.popUpBox').show();
	$.ajax({
		url: "{php echo $this->createMobileUrl('kcajax', array('op' => 'get_all_kslist'), true)}",
		type: 'POST',
		dataType: 'json',
		data: {
			day: day,
			sid: "{$it['sid']}",
			schoolid:"{$schoolid}"
		},
		success: function(data) {
			if (data.result) {
				var kslist = data.kslist;
				// console.log(kslist)
				// var OldOrNew = data.OldOrNew;
				// if(OldOrNew == 1){
				// 	$('#lkqd').show();
				// }
				var htmls = "";
				var avatar = "{OSSURL}public/mobile/img/B_gou.png";
				for (var i = 0; i < kslist.length; i++) {
					var OldOrNew = kslist[i]['OldOrNew'];
					var kcid = kslist[i]['kcid'];
					var kcname = kslist[i]['kcname'];
					htmls += `<div class='famiyls'><div style="margin: auto;"><div class='left_name'>${kcname}</div></div></div>`;
					if (kslist[i].kslist.length > 0) {
						kslist[i].kslist.forEach(function (e, index) {
							if(OldOrNew == 0){
								var isqr= e.isqr;
								var isqd= e.isqd;
								if(isqd){
									if(isqr){
										htmls += `<div class='famiyls'><div class='left'><div class='left_name'>${e.sdname}</div></div><div class='right'><span>老师已确认</span><div class='qdbtnre'><img src="${avatar}"></div></div></div>`;
									}else{
										htmls += `<div class='famiyls'><div class='left'><div class='left_name'>${e.sdname}</div></div><div class='right'><span>等待老师确认</span><div class='qdbtnre'></div></div></div>`;
									}
								}else{
									htmls += `<div class='famiyls' id="${e.id}"><div class='left'><div class='left_name'>${e.sdname}</div></div><div class='right'><span id='qd_word${e.id}'>未签到</span><div class='qdbtn' id='qdbtn${e.id}' onclick='qd(${e.id},${kcid});'>签到</div></div></div>`;
								}
							}
							if(OldOrNew == 1){
								var isqr= e.isqr;
								var singid= e.id;
								if(isqr){
									htmls += `<div class='famiyls'><div class='left'><div class='left_name'>${e.sdname}</div></div><div class='right'><span>老师已确认</span><div class='qdbtnre'><img src="${avatar}"></div></div></div>`;
								}else{
									htmls += `<div class='famiyls' id='sinlist${singid}'><div class='left'><div class='left_name'>${e.sdname}</div></div><div class='right'><span>等待老师确认</span><div class='qdbtnre'></div></div><div class='btnDeleteBox' onclick='del_sign(${singid});return false;' style='position: relative;'><img src='{OSSURL}public/mobile/img/btn_delete_01.png' class='img-responsive'></div></div>`;
								}	
							}
						});
					}else{
						htmls += "<div class='famiyls' id='nolist'><div class='left'><div class='left_name'>今日未签到或无课</div></div><div class='right'><span></span><div class='qdbtnre'></div></div></div>";
					}
				}	
				$("#family").html(htmls);
			}else{
				jTips(data.msg);
			}
		}
	});
}


function qd(ksid,kcid) {
	jConfirm('老师确认才会生效，确认签到吗？', '', function(r) {
		if (r) {
			$.ajax({
				url: "{php echo $this->createMobileUrl('kcajax',array('op'=>'skcsign'))}",
				data: {kcid:kcid,ksid:ksid,schoolid:"{$schoolid}",weid:"{$weid}",sid:"{$it['sid']}"},	
				dataType: 'json',
				type: "post",
				success: function (data) {
					jTips(data.msg, function () {
						if(data.result){
							$("#qdbtn"+ksid).hide();
							$("#qd_word"+ksid).html("等待老师确认");
						}
						return true;
					});
				}
			});
		}
	});
}
</script>